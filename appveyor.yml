version: 1.0.{build}
environment:
  githubpwd:
    secure: h7zhWIG5sQBVM6loU77ClQ==
  deploy_token:
    secure: KnRXHuLNsbckLFp46G7eh+vgioe1zT7GIPPRzDyv6LD8wIMiZ9YGGrf5T8J8HVOV
install:
- cmd: >-
    npm install npm -g

    npm install aurelia-cli -g
    
    npm install
    
    nuget install GitVersion.CommandLine -ExcludeVersion -Source https://www.nuget.org/api/v2/ -Out packages
build_script:
- cmd: >-
    packages\GitVersion.CommandLine\tools\GitVersion.exe /l console /output buildServer /updateassemblyinfo
    
    au build --env prod
test_script:
- cmd: au test
artifacts:
- path: wwwroot/scripts
  name: scripts
deploy:
- provider: GitHub
  description: $(GitVersion_SemVer)
  auth_token:
    secure: 3d2qqSejMw7dKAPRA3pFqQ==
  draft: false
  prerelease: true
  on:
    branch: master
after_deploy:
- git config --global credential.helper store
- ps: Add-Content "$env:USERPROFILE\.git-credentials" "https://$($env:deploy_token):x-oauth-basic@github.com`n"
- cmd: >-
    git config --global user.email "aguacongas@gmail.com"
    
    git config --global user.name "AppVeyor"
    
    git clone -q --branch=gh-pages https://github.com/aguacongas/chatle.aurelia.git deploy
    
    cd deploy
    
    copy /Y ..\wwwroot\index.html .
    
    copy /Y ..\wwwroot\scripts\app-bundle.js scripts
    
    copy /Y ..\wwwroot\scripts\vendor-bundle.js scripts
    
    git add .
    
    git commit --amend --reset-author -m "deploy %APPVEYOR_BUILD_VERSION%"
    
    git push --no-verify --force-with-lease
